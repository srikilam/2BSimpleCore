{
  "feature_code": "CNRC001",
  "feature_name": "Cane Receive",
  "module": "AGM",
  "business_context": "The Cane Receiving feature enables efficient issuance of receiving notes (PDF with QR code) for trucks that have completed check-in and dumping at the factory. Currently, gate operations must manually collect dump results from the factory system, print A4 documents with QR codes, and manually update CBM status and weigh-coin management, resulting in slow processing with manual data entry errors. This feature addresses these pain points by providing: (1) Auto-fetch dump results from external factory system with 95%+ success rate, (2) Manual fallback mode when auto-fetch fails, allowing staff to enter ccs and net_weight_kg with 2-decimal validation, (3) Automatic PDF+QR generation with receiving_id embedded, (4) Automatic CBM status update to awaiting_payment via PATCH API, (5) Automatic weigh-coin release via POST API, (6) Support for three source types (CBM booking, NBM with payment preferences, CENTRAL quota), (7) Void functionality with reason tracking that reverts CBM status and prevents payment processing, (8) QR code scanning to quickly resolve check-in and open Issue Drawer, (9) Idempotent POST operations with X-Idempotency-Key to prevent duplicate receiving notes, (10) Optimistic locking with ETag/If-Match for void operations to prevent race conditions, and (11) Comprehensive audit trails with actor tracking and event emission (cane_receiving.issued, cane_receiving.void). The system enforces strict RBAC (Receiving Staff, Supervisor, Viewer roles) and aims to reduce time from drawer open to issued status to ≤60 seconds while maintaining void rate <2% per day.",
  "user_story": [
    "As a Receiving Staff member, I want to issue receiving notes with auto-fetched dump results from the factory system, so that I can quickly provide farmers with their receiving documents (PDF+QR) without manual data entry and reduce processing time to ≤60 seconds",
    "As a Receiving Staff member, I want the system to automatically fall back to manual mode when auto-fetch fails, so that I can enter ccs and net_weight_kg manually with proper validation (2 decimal places) and still issue the receiving note without delays",
    "As a Receiving Staff member, I want to scan QR codes to instantly open the Issue Drawer for a specific check-in, so that I can skip list navigation and start the receiving process immediately",
    "As a Receiving Staff member, I want the system to automatically free the weigh-coin and update CBM status to awaiting_payment when I issue a receiving note, so that the payment process is triggered seamlessly without manual intervention",
    "As a Receiving Staff member, I want to void an issued receiving note before payment by providing a reason (min 5 chars), so that I can correct errors and the system automatically reverts CBM status to awaiting_dump_result and prevents payment processing",
    "As a Supervisor, I want to review and issue receiving notes with manual override capabilities, so that I can handle special cases where auto-fetch fails or data needs correction",
    "As a Supervisor, I want to void receiving notes in exceptional situations beyond normal constraints, so that I can handle policy-dependent cases that require higher authorization",
    "As a Viewer, I want to view receiving note details and download PDFs, so that I can provide farmers with their documents without modifying any data",
    "As a System Admin, I want all receiving note creation to use idempotency keys (X-Idempotency-Key), so that duplicate submissions don't create multiple receiving notes and maintain data integrity",
    "As a System Admin, I want the system to emit EventBus events (cane_receiving.issued, cane_receiving.void) with full payload details, so that downstream systems (Payment, Analytics) receive real-time updates for processing",
    "As a System Admin, I want the system to support three source types (CBM, NBM with payment preferences, CENTRAL quota), so that all booking modes from check-in are properly handled in receiving",
    "As a Receiving Staff member, I want to export receiving lists to CSV with current filters applied, so that I can generate reports for management review",
    "As an Audit/QA user, I want to view complete audit trails with actor, timestamp, dump_fetch_mode, void_reason, and PDF references, so that all receiving activities are traceable and compliant"
  ],
  "acceptance_criteria": [
    "Issue Receiving Auto Success (CBM): Receiving Staff opens Issue Drawer from list or scan, check-in snapshot (farmer/vehicle/weigh_coin/checkin_time) displayed read-only, clicks 'ดึงผลการเท (Auto)', system calls GET /ext/factory/dump?quota_id={id}&date={iso}&weigh_coin={coin} with 3 retry attempts, factory returns {ccs: 11.25, net_weight_kg: 1250.50, fetch_status: success}, fields populated and locked (read-only), dump_fetch_mode set to 'auto', clicks 'ยืนยันออกใบรับอ้อย', POST /api/cane-receivings with X-Idempotency-Key creates receiving_id (CRN-YYYY-NNNNN), generates PDF with QR code containing receiving_id, calls POST /api/weigh-coin/free {weigh_coin: 12345}, calls PATCH /api/cbm/{booking_id}/status {status: awaiting_payment}, emits cane_receiving.issued event, navigates to Detail page with toast 'ออกใบรับอ้อยเรียบร้อย'",
    "Issue Receiving Auto Fail Manual Fallback: Auto fetch fails after 3 retries (404/timeout/error), system shows inline error 'ไม่พบผลการเทจากโรงงาน — กรุณากรอกข้อมูลด้วยตนเอง', sets dump_fetch_mode to 'manual', enables ccs and net_weight_kg input fields, focus moves to ccs input, Receiving Staff enters values (validates: regex /^\\d+(\\.\\d{1,2})?$/, 2 decimal places, >= 0), clicks confirm, POST with dump_fetch_mode='manual', same side-effects as auto success (weigh-coin free, CBM update, PDF generation), emits release.dump_fetch_failed and release.submitted.manual telemetry events",
    "Issue Receiving NBM/CENTRAL Variants: NBM check-in snapshot includes payment_prefs {method, account} displayed read-only, CENTRAL may not have quota_id and uses date+weigh_coin for factory lookup, displays 'โควต้ากลาง' badge in list, same validation and side-effects as CBM mode but with appropriate source_type (NBM/CENTRAL) stored in receiving record",
    "Void Receiving: Receiving Staff/Supervisor selects Issued receiving on Detail page (status must be Issued and NOT linked to Payment), clicks Void button, Void Confirm Modal opens with focus on void_reason textarea, enters reason (required, min 5 chars), clicks confirm, POST /api/cane-receivings/{id}/void with If-Match: ETag and {void_reason: 'text'}, server sets status='Void', sets voided_at/voided_by, calls PATCH /api/cbm/{booking_id}/status {status: awaiting_dump_result}, emits cane_receiving.void event, UI updates status badge to 'ยกเลิก', toast shows 'ยกเลิกสำเร็จ'",
    "Scan QR to Issue: Receiving Staff clicks 'สแกน QR' from list, navigates to /agri/cane-receiving/scan fullscreen overlay, requests camera permission and starts live preview, QR code detected and parsed, calls POST /api/scan/resolve {qr_payload: 'CHK:CHK-0001'}, resolves to checkin_id, opens Issue Drawer for that check-in, fallback to manual input field if camera unavailable/permission denied",
    "List View with Search/Filter: GET /api/cane-receivings returns items ready for receiving (CBM/NBM/CENTRAL), search across plate/driver_phone/CBM|NBM/weigh_coin with debounce 300ms, filters: date_from/date_to (ISO-8601), source_type (enum), status (draft/issued/void), weigh_coin, pagination (page default 1, page_size default 25), sort (default -updated_at), displays columns: receiving_id, source_type badge, source_ref, weigh_coin, driver info, checkin_time (Thai Buddhist Era), dump_fetch_mode, ccs, net_weight_kg, status, actions (Issue/View/Print/Void conditional)",
    "CSV Export: GET /api/cane-receivings?{current_filters}&export=csv returns synchronous CSV download with Thai column headers: checkin_id, source_type, cbm_id/nbm_id, quota_id, plate_no, driver_name, driver_phone, weigh_coin, ccs, net_weight_kg, dump_fetch_mode, issued_at, status, created_by, created_at; RBAC-filtered results (Receiving Staff/Supervisor/Viewer with scope restrictions can export)",
    "Field Validations: dump_fetch_mode=manual requires ccs (numeric(5,2), >= 0, exactly 2 decimals), net_weight_kg (numeric(10,2), >= 0, exactly 2 decimals); dump_fetch_mode=auto locks fields read-only; void_reason (required on void, min 5 chars); receiving_id pattern ^CRN-\\d{4}-\\d{5}$; date filters (ISO-8601 format); source_type (enum CBM|NBM|CENTRAL); status (enum draft|issued|void)",
    "Status Transitions: Draft→Issued (POST /api/cane-receivings), Issued→Void (POST void with If-Match); blocked: cannot Issue from Void, cannot Void from Draft, cannot Void if linked to Payment, cannot edit after Issued (must Void and recreate)",
    "Idempotency: POST /api/cane-receivings requires X-Idempotency-Key header with pattern ui:{user_id}:{checkin_id}:{hash(ccs|net_weight_kg|weigh_coin)}; duplicate key returns original 201 response with existing resource without re-execution; idempotency key stored with request hash",
    "Optimistic Locking: GET /api/cane-receivings/{id} returns ETag header format W/\"v{version}-{updated_at_epoch}\"; client stores ETag and sends If-Match on POST void; 412 PRECONDITION_FAILED on ETag mismatch with error dialog 'ข้อมูลไม่ทันสมัย กรุณารีเฟรช' and refresh button",
    "RBAC Enforcement: Receiving Staff (create all modes, view list/detail, scan QR, dump fetch/toggle/clear, initiate void conditionally, export CSV, generate PDF, weigh-coin free, CBM update); Supervisor (all Receiving Staff permissions plus void in special cases, intervene in manual mode); Viewer (view-only list/detail, export PDF, export CSV with scope restrictions, no create/edit/void); Admin (full access); 403 FORBIDDEN response with redirect to /agri/cane-receiving and toast on unauthorized action",
    "Audit Trail: Record created_by/updated_by/issued_by/voided_by with user ID from JWT, created_at/updated_at/issued_at/voided_at timestamps (Asia/Bangkok UTC+7), void_reason (required on void, min 5 chars), dump_fetch_mode (auto|manual) logged, version field incremented on each update, pdf_url stored with object storage reference",
    "Error Handling: Standardized error format {code, message, details[], trace_id} with HTTP status codes - 422 CCS_OR_WEIGHT_INVALID (invalid decimal/negative), 404 FACTORY_RESULT_NOT_FOUND (factory dump not found), 409 FACTORY_RESULT_MISMATCH (lookup key mismatch), 409 CBM_STATUS_CONFLICT (CBM invalid status), 409 COIN_ALREADY_FREED (weigh coin already freed), 409 VOID_NOT_ALLOWED (linked to payment), 412 PRECONDITION_FAILED (ETag mismatch), 401 unauthorized, 403 forbidden, 404 not_found, 500 server_error; inline field errors for 422, error banners for 409/412 with appropriate CTAs",
    "EventBus Emissions: cane_receiving.issued event payload {actor_id, receiving_id, status, booking_id, ccs, net_weight_kg, dump_fetch_mode, weigh_coin, correlation_id, timestamp} emitted on successful issue; cane_receiving.void event payload {actor_id, receiving_id, void_reason, correlation_id, timestamp} emitted on successful void; at-least-once delivery semantics",
    "Mobile-Friendly UI: Responsive design for mobile/tablet/desktop breakpoints, date/time display in Thai Buddhist Era (พ.ศ.) using moment-thai library, timezone Asia/Bangkok (UTC+7), all labels/messages in Thai, aria-labels for screen readers, focus order: Breadcrumb→Header→Search→Table→Action Bar, modal/drawer focus trap with restore on close",
    "PDF Generation: POST /api/cane-receivings/{id}/pdf generates A4 PDF with QR code containing receiving_id, stores in object storage, returns pdf_url (signed URL), QR payload format: receiving_id or JSON with receiving_id field, PDF includes: receiving_id, source info, farmer/driver/vehicle details, weigh_coin, ccs, net_weight_kg, issued_at, issued_by",
    "Performance Targets: Auto-fetch success rate ≥ 95% per day (KPI), average time from drawer open to Issued ≤ 60 seconds (KPI), void rate < 2% per day excluding testing period (KPI), factory API retry policy: 3 attempts with exponential backoff, search debounce: 300ms"
  ],
  "data_entities": [
    "receiving_notes table: row_id (UUID PK DEFAULT gen_random_uuid(), internal key), id (VARCHAR(14) UNIQUE NOT NULL CHECK id~'^CRN-\\d{4}-\\d{5}$', public ID), created_at (TIMESTAMPTZ NOT NULL DEFAULT now()), updated_at (TIMESTAMPTZ NOT NULL DEFAULT now()), version (INTEGER NOT NULL DEFAULT 1 CHECK version>0, optimistic lock), status (TEXT NOT NULL DEFAULT 'Draft' CHECK IN Draft|Issued|Void), source_type (TEXT NOT NULL DEFAULT 'CBM' CHECK IN CBM|NBM|CENTRAL), source_ref (VARCHAR(255) NULL, external booking ID), checkin_id (VARCHAR(64) NOT NULL CHECK checkin_id<>'', external check-in ID), checkin_time (TIMESTAMPTZ NULL), checkin_snapshot (JSONB NULL, check-in data snapshot), weigh_coin (INTEGER NULL CHECK weigh_coin>=0), dump_fetch_mode (TEXT NOT NULL DEFAULT 'auto' CHECK IN auto|manual), ccs (NUMERIC(5,2) NULL CHECK ccs>=0 AND ccs=round(ccs,2)), net_weight_kg (NUMERIC(10,2) NULL CHECK net_weight_kg>=0 AND net_weight_kg=round(net_weight_kg,2)), issued_at (TIMESTAMPTZ NULL), issued_by (VARCHAR(64) NULL), voided_at (TIMESTAMPTZ NULL), voided_by (VARCHAR(64) NULL), void_reason (TEXT NULL), pdf_url (TEXT NULL, object storage reference), booking_id (VARCHAR(255) NULL), payment_prefs (JSONB NULL, NBM payment preferences), deleted_at (TIMESTAMPTZ NULL, soft delete); Indexes: PK on row_id, UNIQUE on id, idx_receiving_notes_weigh_coin_checkin_time ON (weigh_coin, checkin_time), idx_receiving_notes_source_type_source_ref ON (source_type, source_ref), idx_receiving_notes_status_updated_at ON (status, updated_at DESC), idx_receiving_notes_checkin_id ON (checkin_id); Public ID generation via trigger fn_receiving_notes_make_public_id() using seq_receiving_note_public_id, pattern CRN-<YYYY>-<NNNNN>",
    "factory_dump_results table: row_id (UUID PK, internal key), id (VARCHAR(14) UNIQUE NOT NULL CHECK id~'^FDR-\\d{10}$', public ID), created_at (TIMESTAMPTZ NOT NULL DEFAULT now()), quota_id (VARCHAR(64) NULL), checkin_date (DATE NOT NULL), weigh_coin (INTEGER NOT NULL CHECK weigh_coin>=0), ccs (NUMERIC(5,2) NULL CHECK ccs>=0 AND ccs=round(ccs,2)), net_weight_kg (NUMERIC(10,2) NULL CHECK net_weight_kg>=0), fetched_at (TIMESTAMPTZ NULL), fetch_status (TEXT NOT NULL DEFAULT 'not_found' CHECK IN success|not_found|mismatch|error), source_payload (JSONB NULL, raw factory response), receiving_row_id (UUID NULL FK→receiving_notes.row_id ON UPDATE CASCADE ON DELETE SET NULL); Indexes: PK on row_id, UNIQUE on id, idx_factory_dump_results_lookup ON (quota_id, checkin_date, weigh_coin), idx_factory_dump_results_receiving_row_id ON (receiving_row_id); Unique constraint uq_factory_dump_results_key ON (quota_id, checkin_date, weigh_coin) PARTIAL when quota_id IS NOT NULL",
    "cane_checkins table (upstream, read-only reference): checkin_id (VARCHAR(64) PK), booking_type (TEXT), booking_id (VARCHAR(255)), payment_prefs (JSONB), farmer_name (VARCHAR(200)), driver_name (VARCHAR(200)), driver_phone (VARCHAR(16)), license_plate (VARCHAR(32)), weigh_coin (INTEGER), checkin_time (TIMESTAMPTZ); accessed via GET /api/checkins/{checkin_id} for check-in snapshot",
    "cbm_bookings table (upstream integration, write via API): cbm_id (VARCHAR(15) PK), farmer_name, quota_id, plate_no, driver_name, driver_phone, scheduled_date_time, phase_cut_transport (status field), status; updated via PATCH /api/cbm/{cbm_id}/status with {status: awaiting_payment} on Issue and {status: awaiting_dump_result} on Void"
  ],
  "api_endpoints": [
    "GET /api/cane-receivings - List/search/filter receiving notes; Headers: Authorization Bearer JWT; Query params: q (search plate/driver_phone/CBM|NBM/weigh_coin), date_from (ISO-8601), date_to (ISO-8601), source_type (CBM|NBM|CENTRAL), status (draft|issued|void), checkin_id, weigh_coin, page (default 1), page_size (default 25), sort (default -updated_at); Response 200: {items[{receiving_id, source_type, source_ref, checkin_id, checkin_time, weigh_coin, dump_fetch_mode, ccs, net_weight_kg, status, issued_at, issued_by, pdf_url}], page, page_size, total}; Used for List page and search/filter",
    "GET /api/cane-receivings/{receiving_id} - Get receiving note detail; Headers: Authorization, If-None-Match (optional); Path params: receiving_id (pattern ^CRN-\\d{4}-\\d{5}$); Response 200: full record with ETag header format W/\"v{version}-{epoch}\"; Error: 404 NOT_FOUND; Used for Detail view and void operations to get ETag",
    "POST /api/cane-receivings - Create/Issue receiving note (idempotent); Headers: Authorization, X-Idempotency-Key (REQUIRED pattern ui:{user_id}:{checkin_id}:{hash}), X-Trace-Id (optional); Body: {checkin_id, source_type, source_ref, weigh_coin, dump_fetch_mode (auto|manual), ccs (numeric 5,2 if manual), net_weight_kg (numeric 10,2 if manual), issuing_by}; Response 201: {receiving_id, status: Issued, issued_at, issued_by, pdf_url}; Side-effects: POST /api/weigh-coin/free {weigh_coin}, PATCH /api/cbm/{booking_id}/status {status: awaiting_payment}, emit cane_receiving.issued event, generate PDF; Errors: 422 CCS_OR_WEIGHT_INVALID, 409 COIN_ALREADY_FREED, 409 CBM_STATUS_CONFLICT; Used for Issue Receiving Journey",
    "POST /api/cane-receivings/{receiving_id}/void - Void receiving note; Headers: Authorization, If-Match (REQUIRED ETag), X-Trace-Id (optional); Body: {void_reason (required min 5 chars)}; Response 200: {receiving_id, status: Void, voided_at, voided_by, void_reason}; Side-effects: PATCH /api/cbm/{booking_id}/status {status: awaiting_dump_result}, emit cane_receiving.void event; Errors: 412 PRECONDITION_FAILED (ETag mismatch), 409 VOID_NOT_ALLOWED (linked to payment), 403 unauthorized; Used for Void Journey",
    "POST /api/cane-receivings/{receiving_id}/pdf - Generate/download PDF; Headers: Authorization; Body: {}; Response 200: {receiving_id, pdf_url (signed URL or public)}; Error: 500 server_error (PDF generation failed); Used for Print/Download action",
    "GET /api/cane-receivings/export - Export CSV; Headers: Authorization; Query params: same as list filters; Response 200: text/csv stream with Thai headers; Error: 403 forbidden (no export permission); Used for Export CSV action",
    "POST /api/scan/resolve - Resolve QR code to checkin or receiving; Headers: Authorization; Body: {qr_payload (string)}; Response 200 checkin: {checkin_id, resolved_type: checkin}; Response 200 receiving: {receiving_id, resolved_type: receiving}; Error: 404 not_found (QR payload not resolved); Used for QR Scanner journey",
    "GET /ext/factory/dump - Fetch dump results from factory (external); Headers: Authorization (integration token); Query params: quota_id (optional for CBM/NBM), date (ISO-8601 required), weigh_coin (integer required); Response 200: {quota_id, checkin_date, weigh_coin, ccs (numeric 5,2), net_weight_kg (numeric 10,2), fetched_at, fetch_status: success}; Errors: 404 FACTORY_RESULT_NOT_FOUND, 409 FACTORY_RESULT_MISMATCH; Retry policy: 3 attempts with exponential backoff; Used for auto-fetch dump results",
    "GET /api/checkins/{checkin_id} - Get check-in snapshot (upstream); Headers: Authorization; Response 200: {checkin_id, booking_type, booking_id, payment_prefs {method, account}, farmer_name, driver_name, driver_phone, license_plate, weigh_coin, checkin_time}; Used to prefill Issue Drawer with check-in snapshot",
    "PATCH /api/cbm/{booking_id}/status - Update CBM booking status (outbound side-effect); Headers: Authorization; Body: {status (awaiting_payment on Issue | awaiting_dump_result on Void)}; Response 200: {booking_id, status, updated_at}; Error: 409 CBM_STATUS_CONFLICT; Called automatically during Issue and Void operations",
    "POST /api/weigh-coin/free - Free weigh coin (outbound side-effect); Headers: Authorization; Body: {weigh_coin (integer)}; Response 200: {weigh_coin, status: freed, freed_at}; Error: 409 COIN_ALREADY_FREED; Called automatically during Issue operation"
  ],
  "api_base_url_note": "Base URL: http://localhost:8080/api (development) or https://api.2bsimple.com/api (production); All endpoints require JWT authentication via Authorization: Bearer <token> header; Rate limit: 120 requests/min per consumer with 429 + Retry-After on exceed; ETag headers returned on GET detail for optimistic locking; X-Idempotency-Key required for POST create operations",
  "linked_features": [
    "CCIN001 (Cane Check-In) - Upstream source for check-in snapshot data; Integration: GET /api/checkins/{checkin_id} provides booking_type, booking_id, payment_prefs, farmer/driver/vehicle details, weigh_coin, checkin_time; receiving process depends on completed check-ins",
    "CBM (Cane Booking Management) - Upstream booking system for CBM mode; Integration: Status transitions via PATCH /api/cbm/{booking_id}/status - sets awaiting_payment on Issue, reverts to awaiting_dump_result on Void; status conflict errors must be handled",
    "Weigh-Coin Management - Resource management for factory weigh coins; Integration: POST /api/weigh-coin/free {weigh_coin} called on Issue to release coin for reuse; duplicate free errors (409) must be handled gracefully",
    "Payment System - Downstream consumer for payment processing; Integration: Reads CBM status awaiting_payment to initiate payment flow, blocks Void operation when receiving is linked to payment (payment linkage detection API needed - TODO); payment completion transitions are handled by Payment system",
    "Factory System (External) - External factory system for dump results; Integration: GET /ext/factory/dump provides ccs and net_weight_kg values; SLA target: 95%+ success rate; retry policy: 3 attempts exponential backoff; timeout configuration needed (TODO)",
    "EventBus - Event streaming platform for system integration; Integration: Emits cane_receiving.issued {actor_id, receiving_id, status, booking_id, ccs, net_weight_kg, dump_fetch_mode, weigh_coin, correlation_id, timestamp} on Issue, emits cane_receiving.void {actor_id, receiving_id, void_reason, correlation_id, timestamp} on Void; at-least-once delivery",
    "PDF Generation Service - Document generation service; Integration: POST /api/cane-receivings/{id}/pdf generates A4 PDF with QR code (receiving_id embedded), stores in object storage, returns pdf_url; PDF layout/format details needed (TODO)",
    "Object Storage - Storage for generated PDF files; Integration: Receives PDF files from generation service, provides signed URLs or public URLs for download/viewing; URL format and expiration policy needed (TODO)",
    "QR Scanner/Resolver - QR code resolution service; Integration: POST /api/scan/resolve {qr_payload} resolves to checkin_id or receiving_id to enable quick navigation; QR payload format standardization needed (TODO)"
  ],
  "dev_status": "pending",
  "assigned_to": "DEV_BOT",
  "reviewer": "ARCHITECT",
  "implementation_notes": [
    "Public ID generation: id field uses trigger fn_receiving_notes_make_public_id() to generate CRN-YYYY-NNNNN format on insert using seq_receiving_note_public_id; row_id (UUID) is internal PK for foreign keys",
    "Optimistic locking: version field incremented on each update; ETag header format W/\"v{version}-{updated_at_epoch}\"; client must provide If-Match on void operations; 412 PRECONDITION_FAILED returned on mismatch",
    "Idempotency protection: X-Idempotency-Key required on POST /api/cane-receivings with pattern ui:{user_id}:{checkin_id}:{hash(ccs|net_weight_kg|weigh_coin)}; server stores key with request hash; duplicate key returns cached 201 response without re-execution",
    "Status transitions: Draft→Issued (POST create), Issued→Void (POST void); blocked: cannot Issue from Void, cannot Void from Draft, cannot Void if payment linked, cannot edit after Issued (must Void and recreate)",
    "Side-effects orchestration: POST /api/cane-receivings triggers synchronous calls to (1) POST /api/weigh-coin/free, (2) PATCH /api/cbm/{booking_id}/status, (3) PDF generation service; transaction rollback if critical side-effects fail; consider async pattern with saga/compensation for production resilience (TODO)",
    "Factory integration: GET /ext/factory/dump with retry policy: 3 attempts, exponential backoff (base 2s, max 8s); timeout per attempt: needs configuration (TODO); success rate monitoring required to meet 95% KPI; fallback to manual mode on all error types (404/409/timeout/5xx)",
    "EventBus emissions: Emit cane_receiving.issued on successful create with full payload; emit cane_receiving.void on successful void with actor and reason; implement at-least-once delivery with deduplication on consumer side; event schema versioning needed (TODO)",
    "RBAC middleware: Extract user role from JWT claims (role field or custom claim); apply role-based filtering (Receiving Staff: full create/void conditional, Supervisor: void override, Viewer: read-only, Admin: all); 403 FORBIDDEN with redirect to /agri/cane-receiving + toast on unauthorized action",
    "Audit fields: created_by/updated_by/issued_by/voided_by store user_id from JWT sub claim; created_at/updated_at/issued_at/voided_at auto-managed by DB triggers with timezone Asia/Bangkok (UTC+7); void_reason required in void API payload with min 5 chars validation",
    "Mobile-friendly UI: Responsive design with breakpoints mobile(<768px)/tablet(768-1024px)/desktop(>1024px); date/time display in Thai Buddhist Era (พ.ศ.) using moment-thai library or custom formatter; timezone Asia/Bangkok (UTC+7); all labels/messages in Thai; aria-labels for screen readers; focus management in modals/drawers",
    "QR scanner: Frontend CameraPreview component uses browser MediaDevices.getUserMedia API; parse receiving_id or checkin_id from QR payload (format: JSON {receiving_id} or raw string or prefixed CHK:); validate pattern before navigation; fallback to manual input if camera unavailable or permission denied",
    "CSV export: Synchronous CSV generation for current filters (async job pattern for >10k records - TODO); columns: receiving_id, source_type, source_ref, checkin_id, quota_id, plate_no, driver_name, driver_phone, weigh_coin, ccs, net_weight_kg, dump_fetch_mode, issued_at, status, created_by, created_at; Thai column headers: เลขที่ใบรับ, ประเภท, อ้างอิง, เช็คอิน, โควต้า, ทะเบียน, ชื่อคนขับ, เบอร์คนขับ, เหรียญชั่ง, CCS, น้ำหนักสุทธิ, โหมด, ออกใบเมื่อ, สถานะ, สร้างโดย, สร้างเมื่อ",
    "Validation patterns: receiving_id (^CRN-\\d{4}-\\d{5}$), ccs (numeric 5,2, >=0, exactly 2 decimals, regex /^\\d+(\\.\\d{1,2})?$/), net_weight_kg (numeric 10,2, >=0, exactly 2 decimals), void_reason (min 5 chars), date filters (ISO-8601), source_type (enum CBM|NBM|CENTRAL), status (enum draft|issued|void), weigh_coin (integer >=0)",
    "Business rules enforcement: R1 (dump_fetch_mode=manual requires ccs and net_weight_kg with 2 decimal validation), R2 (dump_fetch_mode=auto locks fields read-only), R3 (void requires status=Issued AND not linked to payment), R4 (void requires void_reason min 5 chars), R5 (Issue triggers weigh-coin free + CBM status update atomically), R6 (Void reverts CBM status atomically), R7 (PDF generation on Issue with receiving_id embedded in QR)",
    "Error handling: Standardized error response {code, message, details[], trace_id}; HTTP status codes: 422 (CCS_OR_WEIGHT_INVALID field validation), 404 (FACTORY_RESULT_NOT_FOUND factory not found), 409 (FACTORY_RESULT_MISMATCH/CBM_STATUS_CONFLICT/COIN_ALREADY_FREED/VOID_NOT_ALLOWED conflicts), 412 (PRECONDITION_FAILED ETag mismatch), 401 (unauthorized), 403 (forbidden), 500 (server_error); client-side exponential backoff for 429/5xx; inline field errors for 422; error banners with CTAs for 409/412",
    "Performance optimization: Search debounce 300ms; pagination default page_size=25 (configurable); factory API timeout per attempt needs configuration (TODO); consider caching factory dump results in factory_dump_results table for quick retry; lazy load PDF preview in Detail page; compress PDF files before storage",
    "Data test IDs: receiving-list-row-{checkin_id}, btn-open-issue-drawer, checkin-snapshot-card, checkin-snapshot-weigh-coin, btn-dump-fetch-auto, dump-result-ccs, dump-result-net-weight, dump-fetch-error, btn-dump-manual-toggle, input-manual-ccs, input-manual-net-weight, btn-confirm-issue, issue-success-toast, receiving-detail-header, receiving-detail-ccs, receiving-detail-net-weight, btn-print-pdf, pdf-viewer-iframe, btn-void, input-void-reason, btn-void-confirm, void-success-toast, btn-export-csv for E2E testing",
    "TODO HIGH PRIORITY: Define factory API timeout and retry configuration (currently 3 attempts with exponential backoff but timeout per attempt not specified); Define payment linkage detection API/flag to check if receiving is linked to payment (required for void blocking); Define PDF layout/format specification (A4 size, QR position, field layout, Thai fonts); Define QR payload format standardization (JSON vs raw string vs prefixed patterns); Define event payload canonical schemas with versioning; Define rollback/compensation policy when side-effects partially fail (e.g., PDF OK but CBM PATCH fails); Define PII masking pattern for driver_phone in UI/telemetry/logs for data protection compliance"
  ],
  "technical_warnings": [
    "Factory API timeout/retry configuration NOT DEFINED - needs SLA specification (timeout per attempt, max total time, backoff strategy) to meet 95% success rate KPI and 60-second processing time target",
    "Payment linkage detection API/flag NOT DEFINED - required to properly block void operations when receiving is linked to payment; currently no API endpoint to check payment association",
    "PDF A4 layout/format specification INCOMPLETE - detailed layout (field positions, QR code placement, Thai font requirements, header/footer content) not provided; coordinate with design team for complete specification",
    "QR payload format NOT STANDARDIZED - need coordination with Check-In team (CCIN001) and other QR consumers to standardize format (JSON {receiving_id} vs raw receiving_id vs prefixed patterns like RCV:CRN-2025-00001)",
    "Side-effects rollback policy NOT DEFINED - when POST /api/cane-receivings succeeds but PATCH CBM or POST weigh-coin fails, no compensating action specified; recommend saga pattern with compensation or full transaction rollback",
    "Event payload schemas NOT VERSIONED - canonical event schemas for cane_receiving.issued and cane_receiving.void need versioning (e.g., v1) and documentation for downstream consumers; breaking changes require migration plan",
    "CBM PATCH /api/cbm/{booking_id}/status synchronous pattern may cause latency - if CBM service has high latency (>500ms), consider async pattern with event-driven status update to meet 60-second processing target",
    "Factory dump API dependency is critical path - 95% success rate required but no monitoring/alerting spec defined; recommend factory API health check endpoint and dashboard for real-time SLA monitoring",
    "Row-level scoping (branch/gate-limited views) NOT SPECIFIED - if multi-gate/multi-branch deployment requires scoped views for Receiving Staff, add tenant/gate/branch filters to API and RBAC rules",
    "CSV export synchronous pattern may timeout for large datasets - recommend async job pattern with download link for exports >10k records; current implementation suitable for <1k records only",
    "PDF generation service availability is critical - if service down, entire Issue flow blocked; recommend circuit breaker pattern with fallback to deferred PDF generation queue",
    "PII fields (driver_name, driver_phone, farmer_name) require data protection - implement field-level masking in logs/telemetry, ensure compliance with PDPA/GDPR; driver_phone should be masked in UI (show last 4 digits only) unless user has view:pii permission",
    "Rate limiting (120 req/min) may be insufficient during peak harvest season - monitor production usage during high-traffic periods and adjust limits; consider burst allowance for short spikes",
    "Optimistic locking version field relies on single-server clock - in distributed deployment, use updated_at timestamp or vector clocks for ETag generation to prevent clock skew issues",
    "Idempotency key hash collision risk - ui:{user_id}:{checkin_id}:{hash(ccs|net_weight_kg|weigh_coin)} may collide if same user re-submits identical values for different check-ins; consider adding timestamp or random component to hash input"
  ]
}
