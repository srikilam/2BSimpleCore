{
  "feature_code": "ARPE001",
  "feature_name": "Area & Permission",
  "module": "AGM",
  "business_context": "The Area & Permission feature establishes an authoritative single source of truth for managing geographical areas and extension codes within the AGM system. Currently, there is no centralized reference for operational areas and officer codes, causing inconsistencies in downstream systems (Farmer/Quota management). This feature addresses the need for centralized control by providing: (1) CRUD operations for Areas with activate/deactivate status management, (2) full lifecycle management of Extension Codes (create/rename/assign/reassign) with uniqueness enforcement, (3) centralized role management for Directors, Area Heads, and Extension Officers with RBAC-based access control, (4) outbound domain events for downstream system synchronization, and (5) technical consistency through idempotency keys and optimistic locking to prevent race conditions. The system enforces critical business rules including unique 4-digit extension codes, one active code per employee, and guards against deactivating areas with occupied codes.",
  "user_story": [
    "As a System Admin, I want to create and manage geographical Areas with province/district/subdistrict information, so that I can establish an authoritative reference for operational regions",
    "As a System Admin, I want to activate or deactivate Areas with validation guards, so that inactive areas with occupied extension codes cannot be deactivated accidentally",
    "As a Director, I want to view and manage all Areas and Extension Codes across the organization, so that I can maintain oversight of organizational structure",
    "As a System Admin, I want to create unique 4-digit Extension Codes assigned to specific Areas, so that each officer has a distinct identifier",
    "As a System Admin, I want to assign an Extension Code to an employee (EMPTY to OCCUPIED status), so that the employee can be uniquely identified in the system",
    "As a System Admin, I want to reassign an Extension Code from one employee to another atomically, so that ownership transfer is seamless and prevents race conditions",
    "As a System Admin, I want to rename an Extension Code with optimistic locking, so that code updates are conflict-free",
    "As a System Admin, I want to add or remove Directors globally, so that I can manage system-wide supervisory roles",
    "As a System Admin, I want to add or remove Area Heads for specific Areas, so that each area has designated leadership",
    "As an Area Head, I want to view Areas and Extension Codes within my assigned area only, so that I can focus on my area of responsibility",
    "As an Extension Officer, I want to view only the Extension Code assigned to me, so that I can access relevant operational data",
    "As a System Admin, I want to search, filter, sort, and export Areas and Extension Codes to CSV, so that I can analyze and report on organizational structure",
    "As a System Admin, I want the system to validate employee status with ERP and prevent inactive employees from being assigned, so that only active employees receive codes",
    "As a System Admin, I want the system to auto-populate postal codes from Address Master based on subdistrict selection, so that address data is accurate and consistent",
    "As an Audit/QA user, I want to view audit timelines for all changes to Areas, Codes, and assignments, so that I can track system activity and compliance"
  ],
  "acceptance_criteria": [
    "Area CRUD: System Admin and Director can create Areas with unique area_name, province_id, district_id, subdistrict_id, address_line, and description",
    "Area creation must auto-populate postal_code from Address Master API based on subdistrict_id (read-only field)",
    "Area updates require If-Match header with version for optimistic locking; return 412 on version mismatch",
    "Area deactivation is blocked (409 CONFLICT) if the Area contains any Extension Codes with status OCCUPIED",
    "Extension Code creation requires unique 4-digit display_code (regex: ^\\d{4}$) globally across the system",
    "Extension Code creation must specify area_id, display_code, and optional note; initial status is EMPTY",
    "Extension Code assignment (assign) is allowed only when code status is EMPTY and employee has no active code; employee must be active in ERP",
    "Extension Code reassignment (reassign) is atomic: from_code becomes EMPTY, to_code becomes OCCUPIED; target code must be EMPTY; return 423 on race condition",
    "Extension Code rename requires If-Match header with version; new display_code must be unique; return 409 on duplicate",
    "Physical deletion of Extension Codes is prohibited (R6 policy); soft-delete or status management only",
    "Director assignment: employee_id must be unique globally; employee must be active in ERP",
    "Area Head assignment: employee_id must be unique per Area; one employee can be head of multiple Areas",
    "All POST operations for create/assign/reassign must include X-Idempotency-Key header for safe retries",
    "List APIs (Areas, Extension Codes, Directors) must support search (q), filters (province_id, district_id, subdistrict_id, area_id, status), sorting, and pagination (page, page_size)",
    "Export endpoints (/api/areas/export, /api/extension-codes/export) return CSV with RBAC-filtered results",
    "RBAC enforcement: Area Head sees only assigned Areas; Extension Officer sees only own code; Director and Admin see all",
    "System emits outbound domain events: ext_code.assigned, ext_code.reassigned, ext_code.renamed, area.updated with payload (ext_code_id, display_code, area_id, employee_id, timestamps)",
    "All write operations record created_by/updated_by/assigned_by with user's full name (first_name + last_name) from external_users table; defaults to 'system' if not authenticated",
    "API error responses follow standard format: {code, message, details[], trace_id} with appropriate HTTP status codes (400, 401, 403, 404, 409, 412, 422, 423, 424, 500)",
    "Audit timeline displays all create/update/assign/reassign/status changes with actor, timestamp, and before/after snapshots"
  ],
  "data_entities": [
    "Areas (areas table): id (int64 PK), area_name (unique), province_id, district_id, subdistrict_id, postal_code (auto-populated), address_line, description, status (Active/Inactive), version, created_at, updated_at, created_by (full_name), updated_by (full_name), deleted_at (soft delete)",
    "ExtensionCodes (extension_codes table): id (int64 PK), display_code (unique 4-digit), area_id (FK to areas), note, status (EMPTY/OCCUPIED), version, created_at, updated_at, created_by (full_name), updated_by (full_name), deleted_at (soft delete)",
    "ExtensionCodeAssignments (extension_code_assignments table): id (int64 PK), extension_code_id (FK, unique), employee_id (unique active assignment), area_id (denormalized), assigned_at, assigned_by (full_name), version, deleted_at (soft delete)",
    "AreaHeadAssignments (area_head_assignments table): id (int64 PK), area_id (FK to areas), employee_id (from external_users.employee_no), full_name (virtual field via JOIN), assigned_at, assigned_by (full_name), deleted_at; unique constraint on (area_id, employee_id) WHERE deleted_at IS NULL",
    "Directors (directors table): id (int64 PK), employee_id (unique from external_users.employee_no), full_name (virtual field via JOIN), email (virtual field), dept (virtual field), assigned_at, deleted_at",
    "ExternalUsers (external_users table - ERP reference): id (int64 PK), employee_no (unique), first_name, last_name, email, dept, status; used for authentication and audit trail"
  ],
  "api_endpoints": [
    "GET {{base_url}}/agm/areas - List Areas with filters (q, province_id, district_id, subdistrict_id, status, page, page_size, sort) [JWT required]",
    "GET {{base_url}}/agm/areas/{id} - Get Area detail [JWT required]",
    "POST {{base_url}}/agm/areas - Create Area (requires X-Idempotency-Key) [JWT required]",
    "PATCH {{base_url}}/agm/areas/{id} - Update Area (requires If-Match version) [JWT required]",
    "PATCH {{base_url}}/agm/areas/{id}/status - Toggle Area status (requires If-Match, guard: no OCCUPIED codes) [JWT required]",
    "DELETE {{base_url}}/agm/areas/{id} - Soft delete Area [JWT required]",
    "GET {{base_url}}/agm/areas/{id}/heads - List Area Heads for Area [JWT required]",
    "POST {{base_url}}/agm/areas/{id}/heads - Add Area Head (requires X-Idempotency-Key) [JWT required]",
    "DELETE {{base_url}}/agm/areas/{id}/heads/{employee_id} - Remove Area Head [JWT required]",
    "GET {{base_url}}/agm/extension-codes - List Extension Codes with filters (q, area_id, status, page, page_size, sort) [JWT required]",
    "GET {{base_url}}/agm/extension-codes/{id} - Get Extension Code detail with current assignment [JWT required]",
    "POST {{base_url}}/agm/extension-codes - Create Extension Code (requires X-Idempotency-Key) [JWT required]",
    "PATCH {{base_url}}/agm/extension-codes/{id}/rename - Rename Extension Code (requires If-Match) [JWT required]",
    "POST {{base_url}}/agm/extension-codes/{id}/assign - Assign officer to code (requires X-Idempotency-Key) [JWT required]",
    "POST {{base_url}}/agm/extension-codes/reassign - Reassign officer atomically (requires X-Idempotency-Key) [JWT required]",
    "GET {{base_url}}/agm/directors - List Directors [JWT required]",
    "POST {{base_url}}/agm/directors - Add Director (requires X-Idempotency-Key) [JWT required]",
    "DELETE {{base_url}}/agm/directors/{employee_id} - Remove Director [JWT required]"
  ],
  "api_base_url_note": "{{base_url}} = http://localhost:8080/api/v1 (development) or https://api.2bsimple.com/api/v1 (production)",
  "linked_features": [],
  "dev_status": "completed",
  "assigned_to": "DEV_TEAM",
  "reviewer": "ARCHITECT",
  "implementation_notes": [
    "JWT authentication middleware applied to all /agm routes for user context extraction",
    "Helper function helpers.GetCurrentUserFullName() created for centralized audit field population",
    "Audit fields (created_by, updated_by, assigned_by) store full names from external_users.first_name + last_name",
    "Virtual fields (full_name, email, dept) in AreaHeadAssignment and Director models use LEFT JOIN with external_users",
    "Partial unique indexes with WHERE deleted_at IS NULL clause for soft-delete pattern enforcement",
    "Optimistic locking implemented via version field with If-Match header validation",
    "Idempotency protection via X-Idempotency-Key header for all POST operations",
    "Auto-population of postal_code from province_id, district_id, subdistrict_id via Thailand address lookup",
    "All tests passed: Areas CRUD, Extension Codes lifecycle, Area Heads management, Directors management",
    "Documentation updated: OpenAPI spec, Postman collection, Feature Config"
  ]
}
