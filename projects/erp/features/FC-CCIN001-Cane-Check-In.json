{
  "feature_code": "CCIN001",
  "feature_name": "Cane Check-In",
  "module": "AGM",
  "business_context": "The Cane Check-In feature enables efficient and secure check-in of sugarcane delivery trucks at the factory gate. Currently, gate operations must handle both scheduled bookings from the CBM (Cane Booking Management) system and non-scheduled deliveries, but the existing process lacks comprehensive support for all modes and has safety issues such as duplicate coin numbers and incomplete payment data. This feature addresses these pain points by providing: (1) Three check-in modes (CBM booking, member no-booking, guest pool) with specific validation rules for each, (2) Partial-unique coin_number enforcement to prevent duplicates in active records, (3) Mandatory payment configuration (payment_type_1st/2nd and debt_payment_percent) for member no-booking mode, (4) Automatic CBM booking status updates via PATCH to awaiting_payment state, (5) QR code scanning for fast CBM data prefill with manual fallback, (6) Void functionality with coin_number release for pre-completion corrections, (7) EventBus integration for downstream system synchronization (cane.checkin.created, cane.checkin.voided), and (8) Mobile-friendly UI with Thai Buddhist Era date/time display. The system enforces strict RBAC (Gate Staff, Dispatcher, Logistics Supervisor roles) and maintains comprehensive audit trails with optimistic locking to prevent race conditions.",
  "user_story": [
    "As a Gate Staff, I want to check in CBM-scheduled trucks by selecting from the dispatch queue or scanning QR codes, so that booking data is auto-filled and I can quickly confirm arrivals",
    "As a Gate Staff, I want to check in member trucks without bookings by searching for their quota and entering payment terms (payment_type_1st/2nd, debt_payment_percent), so that non-scheduled deliveries are properly recorded",
    "As a Gate Staff, I want to check in guest trucks using the guest pool mode, so that trucks without member quota can still be processed",
    "As a Gate Staff, I want the system to prevent duplicate coin_number entries for active check-ins, so that queue conflicts are eliminated",
    "As a Gate Staff, I want to scan QR codes to auto-fill CBM booking details, so that manual data entry errors are reduced",
    "As a Gate Staff, I want to void check-ins before they reach completed status, so that I can correct mistakes and release coin numbers for reuse",
    "As a Dispatcher, I want to view the pending dispatch queue and completed check-ins in separate tabs with search/filter capabilities, so that I can monitor queue status without creating entries",
    "As a Logistics Supervisor, I want to review and approve void requests (policy-dependent), so that cancellations are properly authorized",
    "As a System Admin, I want check-in creation to automatically update CBM booking status to awaiting_payment via PATCH API, so that the payment process is triggered seamlessly",
    "As a System Admin, I want the system to emit EventBus events (cane.checkin.created, cane.checkin.voided), so that downstream systems (Payment, Analytics) receive real-time updates",
    "As a System Admin, I want all check-in operations to use idempotency keys and optimistic locking, so that concurrent requests and retries are safely handled",
    "As a Gate Staff, I want to export check-in lists to CSV with current filters applied, so that I can generate reports for management",
    "As an Audit/QA user, I want to view complete audit trails with actor, timestamp, and reason (for voids), so that all check-in activities are traceable"
  ],
  "acceptance_criteria": [
    "Check-in creation (CBM mode): Gate Staff selects CBM booking from 'ต้องส่ง' tab, cbm_id/plate_no/driver_name/driver_phone are prefilled (readonly), coin_number is required and validated for uniqueness, POST /api/cane-checkins creates record with status checked_in→awaiting_payment, PATCH /api/cbm/bookings/{cbm_id}/status sets phase_cut_transport='awaiting_payment', EventBus emits cane.checkin.created",
    "Check-in creation (Member no-booking mode): Gate Staff searches and selects quota_id, enters plate_no/driver_name/driver_phone, selects payment_type_1st and payment_type_2nd (green_bill|white_bill), sets debt_payment_percent (0-100, REQUIRED), enters unique coin_number, POST /api/cane-checkins creates record with source_type='member_no_booking' and status awaiting_payment",
    "Check-in creation (Guest pool mode): Gate Staff enters plate_no/driver_name/driver_phone, selects payment_type_1st/2nd, enters unique coin_number, guest_flag=true (auto-set), POST /api/cane-checkins creates record with source_type='guest_pool' and status awaiting_payment",
    "coin_number uniqueness: Partial unique index enforces uniqueness WHERE status IN ('checked_in','awaiting_payment'); duplicate attempts return 409 VALIDATION_FAILED with error details; coin_number released when status→voided or completed",
    "QR code scanning: Modal /cane/check-in/scan opens camera preview, parses cbm_id (pattern ^CBM-\\d{4}-\\d{7}$), auto-fills CBM check-in drawer; manual fallback input available if camera permission denied",
    "Void check-in: Gate Staff selects record from 'เช็คอินแล้ว' tab where status≠completed, opens void modal, enters reason (required, min 5 chars), POST /api/cane-checkins/void with X-Idempotency-Key and If-Match changes status→voided, releases coin_number atomically, emits cane.checkin.voided event",
    "List view: Two tabs - 'ต้องส่ง' (GET /api/cbm/bookings?status=dispatch) shows pending CBM bookings, 'เช็คอินแล้ว' (GET /api/cane-checkins) shows completed check-ins; search across cbm_id/quota_id/plate_no/coin_number with debounce 300ms; filters: status, source_type, guest_only, date range; sort by columns (default: -checkin_time); pagination (page, page_size)",
    "CSV export: GET /api/cane-checkins?{current_filters}&export=csv returns synchronous CSV download; RBAC-filtered results; Gate Staff/Dispatcher/Logistics Supervisor can export",
    "Field validations: coin_number (required, length 1-12), driver_phone (pattern ^0\\d{8,9}$), cbm_id (pattern ^CBM-\\d{4}-\\d{7}$), debt_payment_percent (integer 0-100, REQUIRED for member_no_booking, NULL for guest_pool), payment_type_1st/2nd (IN green_bill|white_bill, REQUIRED for member_no_booking and guest_pool)",
    "Status transitions: checked_in→awaiting_payment (auto), awaiting_payment→completed (Payment system callback), checked_in|awaiting_payment→voided (manual void); edits blocked when status IN ('awaiting_payment','completed'); void blocked when status='completed'",
    "Idempotency: All POST operations require X-Idempotency-Key header with pattern ui:{user_id}:create_checkin:{hash} or ui:{user_id}:void:{checkin_id}; duplicate key returns original 201/200 response without re-execution",
    "Optimistic locking: PATCH /api/cane-checkins/{id} requires If-Match header with ETag (derived from version field); 412 CONFLICT_UPDATE_STALE on version mismatch; response includes updated ETag",
    "RBAC enforcement: Gate Staff (create all modes, view list/detail, scan QR, initiate void, export CSV); Dispatcher (view-only, export CSV); Logistics Supervisor (view, approve void if policy requires, export CSV); Admin (full access); 403 FORBIDDEN response + redirect + toast on unauthorized action",
    "Audit trail: Record created_by/updated_by/voided_by with user ID, created_at/updated_at/voided_at timestamps, void_reason (required on void), version incremented on each update",
    "Mobile-friendly UI: Responsive design for mobile devices, times displayed in Thai Buddhist Era (พ.ศ.), timezone Asia/Bangkok (UTC+7), all labels/messages in Thai, aria-labels for accessibility",
    "Error handling: Standard error format {code, message, details[], trace_id} with appropriate HTTP status codes (400 VALIDATION_FAILED, 403 FORBIDDEN, 404 NOT_FOUND, 409 conflict, 412 CONFLICT_UPDATE_STALE, 422 unprocessable, 429 rate limit); rate limit: 120 req/min per consumer",
    "API response headers: ETag on GET detail and successful mutations, Retry-After on 429 responses; client implements exponential backoff for 429/5xx errors",
    "EventBus payloads: cane.checkin.created {actor_id, checkin_id, status, cbm_id, coin_number, correlation_id}, cane.checkin.voided {actor_id, checkin_id, released_coin_number, voided_at}"
  ],
  "data_entities": [
    "cane_checkins table: row_id (uuid PK, internal), id (varchar(15) UNIQUE, pattern ^CHK-\\d{4}-\\d{6}$, public ID), created_at (timestamptz NOT NULL DEFAULT now()), updated_at (timestamptz NOT NULL DEFAULT now()), version (integer NOT NULL DEFAULT 1, optimistic lock), checkin_time (timestamptz NOT NULL DEFAULT now()), source_type (text NOT NULL DEFAULT 'cbm_booking', CHECK IN cbm_booking|member_no_booking|guest_pool), cbm_id (varchar(15) NULL, pattern ^CBM-\\d{4}-\\d{7}$, FK upstream), quota_id (varchar(64) NULL), plate_no (varchar(32) NULL), driver_name (varchar(200) NULL, PII), driver_phone (varchar(16) NULL, pattern ^0\\d{8,9}$, PII), coin_number (varchar(12) NOT NULL, length 1-12, partial unique index WHERE status IN checked_in|awaiting_payment), entry_channel (varchar(64) NULL), payment_type_1st (text NULL, CHECK IN green_bill|white_bill), payment_type_2nd (text NULL, CHECK IN green_bill|white_bill), debt_payment_percent (integer NULL, CHECK BETWEEN 0 AND 100), status (text NOT NULL DEFAULT 'checked_in', CHECK IN checked_in|awaiting_payment|completed|voided), guest_flag (boolean NOT NULL DEFAULT false), notes (text NULL), created_by (varchar(64) NOT NULL DEFAULT 'system'), updated_by (varchar(64) NULL), voided_at (timestamptz NULL), voided_by (varchar(64) NULL), void_reason (text NULL); Indexes: pk on row_id, unique on id, idx on created_at/updated_at/checkin_time/status/source_type/cbm_id/quota_id/plate_no/driver_phone/entry_channel/guest_flag/created_by/updated_by/voided_at, partial unique on coin_number WHERE status IN checked_in|awaiting_payment, composite on (status, updated_at)",
    "cbm_bookings table (upstream, read-only): cbm_id (varchar(15) PK), farmer_name, quota_id, plate_no, driver_name, driver_phone, scheduled_date_time, phase_cut_transport (status field), status; accessed via GET /api/cbm/bookings?status=dispatch and updated via PATCH /api/cbm/bookings/{cbm_id}/status",
    "quota table (upstream reference): quota_id (varchar(64) PK), quota details; used for member_no_booking mode quota lookup via search API"
  ],
  "api_endpoints": [
    "GET /api/cane-checkins - List/search/filter check-ins; Query params: q (search cbm_id/quota_id/plate_no/coin_number), status (checked_in|awaiting_payment|completed|voided), source_type (cbm_booking|member_no_booking|guest_pool), guest_only (boolean), cbm_id, quota_id, plate_no, coin_number, page (default 1), page_size (default 25), sort (default -checkin_time), export (csv for synchronous download); Headers: Authorization Bearer JWT; Response: {items[], meta{page, page_size, total}} or CSV file [Journey E - Search/Filter/Export]",
    "GET /api/cane-checkins/{checkin_id} - Get check-in detail; Path params: checkin_id (pattern ^CHK-\\d{4}-\\d{6}$); Headers: Authorization; Response: full record with ETag header; Error: 404 NOT_FOUND [Detail view]",
    "POST /api/cane-checkins - Create check-in (CBM/member/guest); Headers: Authorization, X-Idempotency-Key (required, pattern ui:{user_id}:create_checkin:{hash}); Body varies by source_type - CBM: {source_type, cbm_id, plate_no, driver_name, driver_phone, coin_number, notes}, Member: {source_type, quota_id, plate_no, driver_name, driver_phone, payment_type_1st, payment_type_2nd, debt_payment_percent, coin_number, notes}, Guest: {source_type, plate_no, driver_name, driver_phone, payment_type_1st, payment_type_2nd, coin_number, guest_flag=true, notes}; Response 201: {checkin_id, status, checkin_time, coin_number}; Side effects: CBM mode→PATCH /api/cbm/bookings/{cbm_id}/status, emit cane.checkin.created; Error: 409 duplicate coin_number [Journey A/B/C - Create]",
    "PATCH /api/cane-checkins/{checkin_id} - Update check-in (limited by status); Headers: Authorization, If-Match (required, ETag); Body: partial fields (plate_no, driver_name, driver_phone, notes); Precondition: editable only when status NOT IN awaiting_payment|completed; Response 200 with new ETag; Error: 412 CONFLICT_UPDATE_STALE on version mismatch [Edit flow]",
    "POST /api/cane-checkins/void - Void check-in and release coin_number; Headers: Authorization, X-Idempotency-Key (required, pattern ui:{user_id}:void:{checkin_id}), If-Match (recommended); Body: {checkin_id, reason (required, min 5 chars)}; Precondition: status≠completed; Response 200: {checkin_id, status=voided, released_coin_number, voided_at}; Side effects: coin_number atomic release, emit cane.checkin.voided; Error: 409 cannot void completed, 412 ETag mismatch [Journey D - Void]",
    "GET /api/cbm/bookings?status=dispatch - Read CBM bookings (upstream); Headers: Authorization; Response: list of pending dispatch bookings {cbm_id, farmer_name, quota_id, plate_no, driver_name, driver_phone, scheduled_date_time}; Used to populate 'ต้องส่ง' tab [Journey A]",
    "PATCH /api/cbm/bookings/{cbm_id}/status - Update CBM booking status (integration); Headers: Authorization, If-Match (if upstream uses ETag); Body: {phase_cut_transport: awaiting_payment}; Called during CBM check-in flow; Error: 412 if upstream ETag mismatch [Journey A side-effect]",
    "GET /api/cane-checkins/validate - Validate coin_number availability (optional); Query params: coin_number; Headers: Authorization; Response: {available: boolean, message}; Used for client-side preflight validation [Create flows]"
  ],
  "api_base_url_note": "Base URL: http://localhost:8080/api (development) or https://api.2bsimple.com/api (production); All endpoints require JWT authentication via Authorization: Bearer <token> header; Rate limit: 120 requests/min per consumer with 429 + Retry-After on exceed",
  "linked_features": [
    "CBM (Cane Booking Management) - Upstream system for booking queue management; Integration: Read dispatch queue (GET /api/cbm/bookings?status=dispatch), Update booking status (PATCH /api/cbm/bookings/{cbm_id}/status)",
    "Payment System - Downstream consumer for payment processing; Integration: Reads check-in data (source_type, payment_type_1st/2nd, debt_payment_percent, coin_number, checkin_time), Callback to transition status awaiting_payment→completed (API contract NOT DEFINED - TODO)",
    "EventBus - Event streaming platform; Integration: Emits cane.checkin.created and cane.checkin.voided events for downstream system synchronization",
    "Quota Management - Reference system for member quota lookup; Integration: quota_id search/select in member_no_booking mode"
  ],
  "dev_status": "in_progress",
  "assigned_to": "DEV_BOT",
  "reviewer": "ARCHITECT",
  "implementation_notes": [
    "Partial unique index on coin_number enforces uniqueness only for active check-ins: CREATE UNIQUE INDEX uq_cane_checkins_coin_number_active ON cane_checkins(coin_number) WHERE status IN ('checked_in','awaiting_payment')",
    "Public ID generation: id field uses trigger to generate CHK-YYYY-###### format on insert; row_id (uuid) is internal PK",
    "Optimistic locking: version field incremented on each update; ETag header format W/\"v{version}\"; client must provide If-Match on PATCH operations",
    "Idempotency protection: X-Idempotency-Key stored with request hash; duplicate key returns cached response without re-execution; key pattern: ui:{user_id}:create_checkin:{hash(coin_number|source_type|identifier)} for create, ui:{user_id}:void:{checkin_id} for void",
    "Status auto-transition: checked_in immediately transitions to awaiting_payment after successful POST; transition to completed triggered by Payment system webhook (contract pending)",
    "CBM integration: POST /api/cane-checkins for source_type=cbm_booking triggers synchronous PATCH /api/cbm/bookings/{cbm_id}/status; transaction rollback if PATCH fails; consider async pattern for production resilience",
    "EventBus emissions: Emit cane.checkin.created {actor_id, checkin_id, status, cbm_id, coin_number, correlation_id} on successful create; emit cane.checkin.voided {actor_id, checkin_id, released_coin_number, voided_at} on successful void; implement at-least-once delivery semantics",
    "RBAC middleware: Extract user role from JWT claims; apply role-based filtering (Gate Staff: full access, Dispatcher: read-only, Logistics Supervisor: view + approve void, Admin: all); 403 FORBIDDEN with redirect to /cane/check-in + toast on unauthorized action",
    "Audit fields: created_by/updated_by/voided_by store user_id from JWT; created_at/updated_at/voided_at auto-managed by DB triggers; void_reason required in void API payload",
    "Mobile-friendly UI: Responsive design with breakpoints for mobile/tablet/desktop; date/time display in Thai Buddhist Era (พ.ศ.) using moment-thai library; timezone Asia/Bangkok (UTC+7); all labels/messages in Thai; aria-labels for screen readers",
    "QR scanner: Frontend CameraPreview component uses browser MediaDevices API; parse cbm_id from QR payload (expected format: JSON with cbm_id field or raw cbm_id string); validate pattern ^CBM-\\d{4}-\\d{7}$ before auto-fill; fallback to manual input if camera unavailable",
    "CSV export: Synchronous CSV generation for current filters; columns: checkin_id, source_type, cbm_id, quota_id, plate_no, driver_name, driver_phone, coin_number, payment_type_1st, payment_type_2nd, debt_payment_percent, checkin_time, status, created_by, created_at; Thai column headers",
    "Validation patterns: coin_number (length 1-12), driver_phone (^0\\d{8,9}$), cbm_id (^CBM-\\d{4}-\\d{7}$), checkin_id (^CHK-\\d{4}-\\d{6}$), debt_payment_percent (0-100 integer)",
    "Business rules enforcement: R1 (coin_number unique for active), R6 (edits blocked after awaiting_payment), R7 (void blocked for completed), R15 (debt_payment_percent REQUIRED for member_no_booking), R16 (debt_payment_percent 0-100), R17 (debt_payment_percent NULL for guest_pool)",
    "Error handling: Standardized error response {code, message, details[], trace_id}; HTTP status codes: 400 (VALIDATION_FAILED), 403 (FORBIDDEN), 404 (NOT_FOUND), 409 (conflict/duplicate), 412 (CONFLICT_UPDATE_STALE), 422 (unprocessable), 423 (locked), 429 (rate limit), 500 (server error); client-side exponential backoff for 429/5xx",
    "TODO HIGH PRIORITY: Define Payment system webhook API contract for awaiting_payment→completed transition; TODO: Document void approval workflow if Logistics Supervisor approval is required (endpoints/flow currently undefined); TODO: Add data-test-id attributes to all UI components for E2E testing; TODO: Define PII masking pattern for driver_phone in UI/telemetry/logs"
  ],
  "technical_warnings": [
    "Payment webhook/callback API for status transition awaiting_payment→completed is NOT DEFINED in current spec - requires API contract specification before full production deployment",
    "Void approval flow for Logistics Supervisor is policy-dependent but endpoints/workflow are NOT SPECIFIED - need clarification on approval requirement and implementation",
    "Row-level scoping (branch/gate-limited views for Gate Staff) is NOT SPECIFIED - if multi-gate deployment requires scoped views, add tenant/gate filters to API",
    "Partial unique coin_number enforcement relies on DB constraint - ensure proper error handling for constraint violations under high concurrency (409 response with retry logic)",
    "CBM PATCH /api/cbm/bookings/{cbm_id}/status is synchronous in current design - consider async pattern with compensation/retry for production resilience if CBM service has high latency",
    "QR code format/payload structure is assumed but not explicitly defined in upstream spec - coordinate with CBM team to standardize QR payload format",
    "Payment system security (HMAC signature verification) is mentioned but webhook contract is missing - ensure webhook payload integrity verification when API is defined",
    "PII fields (driver_name, driver_phone) require data protection - implement masking in logs/telemetry and ensure compliance with privacy regulations",
    "Rate limiting (120 req/min) may be insufficient for high-traffic factory gates - monitor production usage and adjust limits as needed",
    "CSV export is synchronous which may cause timeouts for large datasets - consider async job pattern with download link for exports >10k records"
  ]
}
